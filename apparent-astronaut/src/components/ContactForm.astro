---
// src/components/ContactForm.astro
export interface Props {
  email: string;
}

const { email } = Astro.props;
---

<!-- Modal overlay -->
<div 
  x-show="showContactForm" 
  @click.away="showContactForm = false"
  @keydown.escape="showContactForm = false"
  class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
  style="display: none;"
  x-cloak
  data-email={email} 
>
  <!-- Modal content -->
  <div 
    class="bg-white rounded-xl shadow-2xl max-w-md w-full"
    @click.stop
  >
    <!-- Header -->
    <div class="flex items-center justify-between p-6 border-b">
      <h3 class="text-2xl font-bold text-gray-900">Contact Us</h3>
      <button 
        @click="showContactForm = false"
        class="text-gray-400 hover:text-gray-600 transition text-2xl"
      >
        ×
      </button>
    </div>

    <!-- Form -->
    <div class="p-6">
      <form 
        x-data="{
          formName: '',
          formEmail: '',
          formMessage: '',
          isSending: false,
          messageSent: false,
          errorMessage: '',
          
         
          get destinationEmail() {
            return this.$el.closest('[data-email]').dataset.email;
          },
          
          async enviarFormulario() {
           
 
            
            this.isSending = true;
            this.messageSent = false;
            this.errorMessage = '';
            
            try {
              const datos = {
                name: this.formName,
                email: this.formEmail,
                message: this.formMessage,
                to: this.destinationEmail
              };
              
              
              
              const response = await fetch('/api/contact', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(datos)
              });
              
             
              
              const responseText = await response.text();
            
              
              let data;
              try {
                data = JSON.parse(responseText);
              } catch (e) {
                console.error('Error parseando respuesta:', responseText);
                throw new Error('Respuesta inválida del servidor');
              }
              
              if (!response.ok) {
                throw new Error(data.error || 'Error al enviar mensaje');
              }
              
              this.messageSent = true;
              this.formName = '';
              this.formEmail = '';
              this.formMessage = '';
              
              setTimeout(() => {
                showContactForm = false;
                this.messageSent = false;
              }, 2000);
              
            } catch (error) {
              
              this.errorMessage = error.message || 'Error al enviar. Intenta de nuevo.';
            } finally {
              this.isSending = false;
            }
          }
        }"
        @submit.prevent="enviarFormulario"
      >
      
        <div class="space-y-4">
          <!-- Name -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
            <input 
              type="text" 
              x-model="formName"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="Your name"
            >
          </div>
          
          <!-- Email -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
            <input 
              type="email" 
              x-model="formEmail"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="your@email.com"
            >
          </div>
          
          <!-- Message -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Message *</label>
            <textarea 
              x-model="formMessage"
              required
              rows="4"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="How can we help you?"
            ></textarea>
          </div>
          
          <!-- Submit button -->
          <button 
            type="submit"
            :disabled="isSending"
            class="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition disabled:opacity-50"
          >
            <span x-show="!isSending">Send Message</span>
            <span x-show="isSending" class="flex items-center justify-center gap-2">
              <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
              </svg>
              Sending...
            </span>
          </button>
          
          
          <div x-show="messageSent" class="p-3 bg-green-100 text-green-700 rounded-lg text-center">
            ¡Message sended successfully!
          </div>
          
          
          <div x-show="errorMessage" class="p-3 bg-red-100 text-red-700 rounded-lg text-center">
            <p x-text="errorMessage"></p>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  [x-cloak] { display: none !important; }
</style>